
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Super Manager</title>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        
        /* Layout */
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .left { flex: 1; min-width: 300px; }
        .right { flex: 2; min-width: 400px; }

        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        /* Inputs */
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 14px; }

        /* Buttons */
        button { cursor: pointer; padding: 10px; border: none; border-radius: 5px; font-weight: bold; width: 100%; }
        .btn-save { background: #28a745; color: white; margin-top: 10px; font-size: 16px; }
        .btn-save:hover { background: #218838; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #343a40; color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        
        /* Row Colors based on Status */
        .row-active { background-color: #d4edda; color: #155724; } /* Green */
        .row-expired { background-color: #f8d7da; color: #721c24; } /* Red */

        /* Action Buttons Small */
        .btn-sm { width: auto; padding: 5px 10px; margin-right: 5px; font-size: 12px; }
        .btn-renew { background: #007bff; color: white; }
        .btn-del { background: #dc3545; color: white; }
        .btn-pdf { background: #6c757d; color: white; }

        /* MODAL (Popup for Renewal) */
        #renewModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    
    <!-- FORM (New Admission) -->
    <div class="box left">
        <h2>‚ûï New Admission</h2>
        <label>Student Name</label>
        <input type="text" id="name" placeholder="Enter Name">
        
        <label>Mobile Number</label>
        <input type="number" id="mobile" placeholder="Mobile No">
        
        <label>Seat Number</label>
        <select id="seat"></select>

        <label>Joining Date</label>
        <input type="date" id="joinDate">

        <label>Plan Duration</label>
        <select id="duration" onchange="calcEndDate()">
            <option value="1">1 Month</option>
            <option value="3">3 Months</option>
        </select>

        <label>Expiry Date (Auto)</label>
        <input type="text" id="expiryDate" readonly style="background:#eee;">

        <label>Fees Amount (‚Çπ)</label>
        <input type="number" id="fees">

        <button class="btn-save" onclick="addStudent()">üíæ SAVE ENTRY</button>
    </div>

    <!-- LIST (Dashboard) -->
    <div class="box right">
        <h2>üìã Student Status List</h2>
        <input type="text" id="search" placeholder="üîç Search Name..." onkeyup="renderTable()">
        
        <table>
            <thead>
                <tr>
                    <th>Name / Mobile</th>
                    <th>Seat</th>
                    <th>Expiry Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data here -->
            </tbody>
        </table>
    </div>
</div>

<!-- RENEWAL POPUP MODAL -->
<div id="renewModal">
    <div class="modal-content">
        <h3>‚ôªÔ∏è Renew Membership</h3>
        <p id="renewName" style="font-weight:bold; color:#007bff;"></p>
        
        <label>Add Duration:</label>
        <select id="renewMonths">
            <option value="1">Add 1 Month</option>
            <option value="3">Add 3 Months</option>
        </select>
        
        <label>Fees Collected (‚Çπ):</label>
        <input type="number" id="renewFees" placeholder="Enter Amount">

        <button class="btn-save" onclick="confirmRenew()">‚úÖ CONFIRM RENEWAL</button>
        <button onclick="closeModal()" style="background:#666; color:white; margin-top:5px;">Cancel</button>
    </div>
</div>

<script>
    // --- 1. SETUP ---
    // Fill Seats 1-50
    const seatSelect = document.getElementById('seat');
    for(let i=1; i<=50; i++) seatSelect.add(new Option(`Seat ${i}`, i));
    
    // Set Today Date
    document.getElementById('joinDate').valueAsDate = new Date();
    calcEndDate();

    let students = JSON.parse(localStorage.getItem('libData')) || [];
    let currentRenewId = null; // To track who we are renewing

    // --- 2. CALCULATE END DATE ---
    function calcEndDate() {
        let d = new Date(document.getElementById('joinDate').value);
        let m = parseInt(document.getElementById('duration').value);
        d.setMonth(d.getMonth() + m);
        document.getElementById('expiryDate').value = d.toISOString().split('T')[0];
    }

    // --- 3. ADD NEW STUDENT ---
    function addStudent() {
        let name = document.getElementById('name').value;
        let mobile = document.getElementById('mobile').value;
        let seat = document.getElementById('seat').value;
        let expiry = document.getElementById('expiryDate').value;
        let fees = document.getElementById('fees').value;

        if(!name || !fees) { alert("Name and Fees required!"); return; }

        let newStudent = {
            id: Date.now(),
            name, mobile, seat, expiry, fees
        };

        students.push(newStudent);
        saveAndRefresh();
        
        // Reset Form
        document.getElementById('name').value = '';
        document.getElementById('mobile').value = '';
        document.getElementById('fees').value = '';
        generatePDF(newStudent, "New Admission"); // Print Receipt
    }

    // --- 4. RENDER TABLE (The Main Dashboard) ---
    function renderTable() {
        let tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let filter = document.getElementById('search').value.toLowerCase();

        students.sort((a,b) => new Date(a.expiry) - new Date(b.expiry)); // Expiring soon first

        students.forEach((s, index) => {
            if(s.name.toLowerCase().includes(filter)) {
                
                // Check if Expired
                let today = new Date().toISOString().split('T')[0];
                let isExpired = s.expiry < today;
                let rowClass = isExpired ? 'row-expired' : 'row-active';
                let statusText = isExpired ? '‚ùå EXPIRED' : '‚úÖ ACTIVE';

                let row = `<tr class="${rowClass}">
                    <td>
                        <strong>${s.name}</strong><br>
                        <small>üìû ${s.mobile}</small>
                    </td>
                    <td>Seat ${s.seat}</td>
                    <td>
                        ${s.expiry}<br>
                        <small style="font-weight:bold;">${statusText}</small>
                    </td>
                    <td>
                        <button class="btn-sm btn-renew" onclick="openRenewModal(${s.id})">‚ôªÔ∏è Renew</button>
                        <button class="btn-sm btn-pdf" onclick='generatePDF(${JSON.stringify(s)}, "Duplicate")'>üñ®Ô∏è</button>
                        <button class="btn-sm btn-del" onclick="delStudent(${index})">üóëÔ∏è</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            }
        });
    }

    // --- 5. RENEWAL LOGIC (The Fix) ---
    function openRenewModal(id) {
        let s = students.find(x => x.id == id);
        currentRenewId = id;
        document.getElementById('renewName').innerText = s.name;
        document.getElementById('renewModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('renewModal').style.display = 'none';
    }

    function confirmRenew() {
        let months = parseInt(document.getElementById('renewMonths').value);
        let fees = document.getElementById('renewFees').value;
        
        if(!fees) { alert("Please enter collected fees!"); return; }

        // Find Student
        let s = students.find(x => x.id == currentRenewId);
        
        // Logic: Extend date from TODAY if expired, or from OLD EXPIRY if active
        let today = new Date();
        let oldExpiry = new Date(s.expiry);
        let baseDate = (oldExpiry > today) ? oldExpiry : today; // Agar abhi active hai to aage badhao, agar expire ho gya to aaj se start karo
        
        baseDate.setMonth(baseDate.getMonth() + months);
        s.expiry = baseDate.toISOString().split('T')[0]; // Update Date
        s.fees = fees; // Update Fees for receipt

        saveAndRefresh();
        closeModal();
        generatePDF(s, "Renewal Receipt"); // Print Receipt
    }

    // --- 6. UTILS ---
    function delStudent(index) {
        if(confirm("Delete this student permanently?")) {
            students.splice(index, 1);
            saveAndRefresh();
        }
    }

    function saveAndRefresh() {
        localStorage.setItem('libData', JSON.stringify(students));
        renderTable();
    }

    // --- 7. GENERATE RECEIPT ---
    async function generatePDF(data, type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFillColor(40, 167, 69); // Green Header
        doc.rect(0,0,210,40,'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(22); doc.text("CITY LIBRARY HUB", 105, 25, null, null, "center");

        doc.setTextColor(0,0,0);
        doc.setFontSize(10); doc.text(`Type: ${type}`, 150, 50);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 55);

        doc.setFontSize(16); doc.text("FEE RECEIPT", 15, 65);
        doc.line(15, 68, 60, 68);

        let y = 85;
        doc.setFontSize(14);
        doc.text(`Student Name:  ${data.name}`, 15, y);
        doc.text(`Seat Number:   ${data.seat}`, 15, y+10);
        doc.text(`Valid Upto:    ${data.expiry}`, 15, y+20);

        doc.setFillColor(240,240,240); doc.rect(15, y+35, 180, 20, 'F');
        doc.text(`Amount Paid: Rs. ${data.fees}/-`, 20, y+48);

        doc.setFontSize(10); doc.setTextColor(100,100,100);
        doc.text("System Generated Receipt | Non-Refundable", 105, 140, null, null, "center");

        doc.save(`${data.name}_Receipt.pdf`);
    }

    // Load table on start
    renderTable();

</script>

</body>
</html>
```

##        }
    }

    // --- 6. DELETE FUNCTION ---
    function deleteStudent(index) {
        if(confirm("Are you sure to delete this record?")) {
            let students = JSON.parse(localStorage.getItem('libraryData')) || [];
            students.splice(index, 1);
            localStorage.setItem('libraryData', JSON.stringify(students));
            loadTable();
        }
    }

    // --- 7. SEARCH FUNCTION ---
    function filterTable() {
        let input = document.getElementById('searchBox').value.toLowerCase();
        let rows = document.getElementById('tableBody').getElementsByTagName('tr');
        
        for(let row of rows) {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
        }
    }

    // --- 8. PDF GENERATOR ---
    async function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFillColor(52, 152, 219);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(22); doc.text("CITY LIBRARY HUB", 105, 25, null, null, "center");

        // Info
        doc.setTextColor(0,0,0);
        doc.setFontSize(10);
        doc.text(`Receipt ID: LIB-${data.id}`, 140, 50);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 55);

        // Content
        doc.setFontSize(18); doc.text("FEE RECEIPT", 15, 65);
        doc.line(15, 68, 60, 68);

        let y = 80;
        doc.setFontSize(14);
        doc.text(`Name: ${data.name}`, 15, y);
        doc.text(`Mobile: ${data.mobile}`, 15, y+10);
        doc.text(`Seat No: ${data.seat}`, 15, y+20);
        doc.text(`Valid From: ${data.start}`, 15, y+30);
        doc.text(`Valid Upto: ${data.end}`, 15, y+40);

        // Status Stamp
        doc.setTextColor(0, 150, 0);
        doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("[ STATUS: ACTIVE ]", 130, y+20);

        // Amount
        doc.setFillColor(240,240,240);
        doc.rect(15, y+55, 180, 20, 'F');
        doc.setTextColor(0,0,0);
        doc.text(`Amount Paid: Rs. ${data.fees}/-`, 20, y+68);

        doc.save(`${data.name}_Receipt.pdf`);
    }
</script>

</body>
</html>
