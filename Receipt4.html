<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Master Database</title>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --red: #e74c3c; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }

        /* LAYOUT */
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-panel { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 300px; }
        .list-panel { flex: 2; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 400px; }

        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* FORM ELEMENTS */
        label { font-weight: bold; font-size: 13px; color: #555; display: block; margin-top: 10px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
        
        .btn-add { width: 100%; background: var(--green); color: white; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-add:hover { background: #219150; }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }

        /* STATUS TAGS */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; }
        .active { background: var(--green); }
        .expired { background: var(--red); }

        /* ACTION BUTTONS */
        .btn-sm { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; color: white; margin-right: 5px; }
        .btn-renew { background: var(--blue); }
        .btn-del { background: var(--red); }
        .btn-print { background: #555; }

        /* SEARCH BAR */
        #searchBox { padding: 10px; width: 100%; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px; }

    </style>
</head>
<body>

<div class="container">
    
    <!-- LEFT SIDE: NEW ADMISSION FORM -->
    <div class="form-panel">
        <h2>‚ûï New Admission / Entry</h2>
        <form id="libForm">
            <input type="hidden" id="editIndex"> <!-- Hidden ID for updates -->
            
            <label>Student Name</label>
            <input type="text" id="name" placeholder="Full Name" required>

            <label>Mobile Number</label>
            <input type="number" id="mobile" placeholder="10 Digit Mobile" required>

            <label>Seat Number</label>
            <select id="seat">
                <!-- Filled by JS -->
            </select>

            <label>Plan Duration</label>
            <select id="plan" onchange="calcDates()">
                <option value="1 Month">1 Month (Monthly)</option>
                <option value="3 Months">3 Months (Quarterly)</option>
                <option value="Custom">Custom Days</option>
            </select>

            <label>Start Date</label>
            <input type="date" id="startDate" onchange="calcDates()" required>

            <label>End Date (Expiry)</label>
            <input type="date" id="endDate" readonly style="background:#eee;">

            <label>Fees Paid (‚Çπ)</label>
            <input type="number" id="fees" placeholder="e.g. 500" required>

            <button type="button" class="btn-add" onclick="saveData()">üíæ SAVE & GENERATE RECEIPT</button>
        </form>
    </div>

    <!-- RIGHT SIDE: DATABASE LIST -->
    <div class="list-panel">
        <h2>üìö Student Database (Active List)</h2>
        <input type="text" id="searchBox" placeholder="üîç Search by Name or Mobile..." onkeyup="filterTable()">
        
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Seat</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Actions (Renew/Print)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data will come here -->
            </tbody>
        </table>
    </div>

</div>

<script>
    // --- 1. INITIAL SETUP ---
    // Fill Seats 1-30
    const seatSelect = document.getElementById('seat');
    for(let i=1; i<=30; i++) seatSelect.add(new Option(`Seat ${i}`, i));
    
    // Set Today's Date
    document.getElementById('startDate').valueAsDate = new Date();
    calcDates();

    // Load Data on Start
    window.onload = loadTable;

    // --- 2. DATE CALCULATION LOGIC ---
    function calcDates() {
        let start = new Date(document.getElementById('startDate').value);
        let plan = document.getElementById('plan').value;
        
        if(plan === "1 Month") start.setMonth(start.getMonth() + 1);
        else if(plan === "3 Months") start.setMonth(start.getMonth() + 3);
        
        document.getElementById('endDate').value = start.toISOString().split('T')[0];
    }

    // --- 3. SAVE DATA (DATABASE) ---
    function saveData() {
        const name = document.getElementById('name').value;
        const mobile = document.getElementById('mobile').value;
        const seat = document.getElementById('seat').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const fees = document.getElementById('fees').value;

        if(!name || !fees) { alert("Name and Fees required!"); return; }

        // Get Existing Data
        let students = JSON.parse(localStorage.getItem('libraryData')) || [];

        // Check for Duplicate Seat (Optional security)
        let isSeatTaken = students.some(s => s.seat == seat && new Date(s.end) >= new Date());
        // Note: For simplicity allowing override, but in real life you'd block it.

        const newEntry = {
            id: Date.now(), // Unique ID
            name, mobile, seat, start, end, fees, 
            status: new Date(end) >= new Date() ? 'Active' : 'Expired'
        };

        // Add to list
        students.push(newEntry);
        localStorage.setItem('libraryData', JSON.stringify(students));

        // Refresh Table & Generate PDF
        loadTable();
        generatePDF(newEntry);
        
        // Reset Form
        document.getElementById('libForm').reset();
        document.getElementById('startDate').valueAsDate = new Date();
        calcDates();
    }

    // --- 4. DISPLAY TABLE (DASHBOARD) ---
    function loadTable() {
        let students = JSON.parse(localStorage.getItem('libraryData')) || [];
        // Sort by Newest First
        students.sort((a,b) => b.id - a.id);
        
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        students.forEach((s, index) => {
            // Check status dynamically
            let isActive = new Date(s.end) >= new Date();
            let statusClass = isActive ? 'active' : 'expired';
            let statusText = isActive ? 'ACTIVE' : 'EXPIRED';

            let row = `<tr>
                <td><strong>${s.name}</strong><br><small>${s.mobile}</small></td>
                <td>${s.seat}</td>
                <td style="color:${isActive?'black':'red'}">${s.end}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn-sm btn-renew" onclick="renewStudent(${s.id})">‚ôªÔ∏è Renew</button>
                    <button class="btn-sm btn-print" onclick='generatePDF(${JSON.stringify(s)})'>üñ®Ô∏è Slip</button>
                    <button class="btn-sm btn-del" onclick="deleteStudent(${index})">‚ùå</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // --- 5. RENEW FUNCTION (Magic Feature) ---
    function renewStudent(id) {
        let students = JSON.parse(localStorage.getItem('libraryData')) || [];
        let s = students.find(x => x.id == id);
        
        if(s) {
            // Fill form with old data
            document.getElementById('name').value = s.name;
            document.getElementById('mobile').value = s.mobile;
            document.getElementById('seat').value = s.seat;
            
            // Set Start Date to TODAY (For renewal)
            document.getElementById('startDate').valueAsDate = new Date();
            calcDates(); // Recalculate End Date
            
            document.getElementById('fees').value = ""; // Ask for fees again
            alert("Details loaded! Enter Fees and Click SAVE to create new receipt.");
        }
    }

    // --- 6. DELETE FUNCTION ---
    function deleteStudent(index) {
        if(confirm("Are you sure to delete this record?")) {
            let students = JSON.parse(localStorage.getItem('libraryData')) || [];
            students.splice(index, 1);
            localStorage.setItem('libraryData', JSON.stringify(students));
            loadTable();
        }
    }

    // --- 7. SEARCH FUNCTION ---
    function filterTable() {
        let input = document.getElementById('searchBox').value.toLowerCase();
        let rows = document.getElementById('tableBody').getElementsByTagName('tr');
        
        for(let row of rows) {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
        }
    }

    // --- 8. PDF GENERATOR ---
    async function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFillColor(52, 152, 219);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(22); doc.text("CITY LIBRARY HUB", 105, 25, null, null, "center");

        // Info
        doc.setTextColor(0,0,0);
        doc.setFontSize(10);
        doc.text(`Receipt ID: LIB-${data.id}`, 140, 50);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 55);

        // Content
        doc.setFontSize(18); doc.text("FEE RECEIPT", 15, 65);
        doc.line(15, 68, 60, 68);

        let y = 80;
        doc.setFontSize(14);
        doc.text(`Name: ${data.name}`, 15, y);
        doc.text(`Mobile: ${data.mobile}`, 15, y+10);
        doc.text(`Seat No: ${data.seat}`, 15, y+20);
        doc.text(`Valid From: ${data.start}`, 15, y+30);
        doc.text(`Valid Upto: ${data.end}`, 15, y+40);

        // Status Stamp
        doc.setTextColor(0, 150, 0);
        doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("[ STATUS: ACTIVE ]", 130, y+20);

        // Amount
        doc.setFillColor(240,240,240);
        doc.rect(15, y+55, 180, 20, 'F');
        doc.setTextColor(0,0,0);
        doc.text(`Amount Paid: Rs. ${data.fees}/-`, 20, y+68);

        doc.save(`${data.name}_Receipt.pdf`);
    }
</script>

</body>
</html>
